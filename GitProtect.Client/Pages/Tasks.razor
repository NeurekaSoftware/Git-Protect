@page "/tasks"
@rendermode InteractiveWebAssembly
@implements IAsyncDisposable
@inject ApiClient Api

<PageTitle>Tasks</PageTitle>

<Card>
    <CardHeader>
        <CardTitle>Tasks</CardTitle>
        <CardDescription>Current and recent backup runs.</CardDescription>
    </CardHeader>
</Card>

<Separator />

@if (isLoading)
{
    <Card><CardContent>Loading tasks...</CardContent></Card>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <Card><CardContent>@error</CardContent></Card>
}
else if (tasks.Count == 0)
{
    <Card><CardContent>No tasks yet.</CardContent></Card>
}
else
{
    <Card>
        <CardContent>
            <table>
                <thead><tr><th>Task</th><th>Status</th><th>Type</th><th>Progress</th><th>Started</th></tr></thead>
                <tbody>
                    @foreach (var task in tasks)
                    {
                        <tr>
                            <td>@task.Name</td>
                            <td>
                                @if (task.Status == BackupTaskStatus.Failed)
                                {
                                    <Badge Variant="BadgeVariant.Destructive">Failed: @(string.IsNullOrWhiteSpace(task.Message) ? "No details" : task.Message)</Badge>
                                }
                                else
                                {
                                    @GetStatusBadge(task.Status)
                                }
                            </td>
                            <td>@GetTriggerBadge(task.Trigger)</td>
                            <td>@task.Progress%</td>
                            <td>@(task.StartedAt?.ToLocalTime().ToString("g") ?? "-")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </CardContent>
    </Card>
}

@code {
    private List<BackupTaskDto> tasks = new();
    private bool isLoading = true;
    private string? error;
    private bool isRefreshing;
    private CancellationTokenSource? refreshCts;
    private PeriodicTimer? refreshTimer;
    private readonly TimeSpan refreshInterval = TimeSpan.FromSeconds(5);

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync(showLoading: true);
        StartAutoRefresh();
    }

    private void StartAutoRefresh()
    {
        refreshCts = new CancellationTokenSource();
        refreshTimer = new PeriodicTimer(refreshInterval);
        _ = RefreshLoopAsync(refreshCts.Token);
    }

    private async Task RefreshLoopAsync(CancellationToken cancellationToken)
    {
        if (refreshTimer is null)
        {
            return;
        }

        try
        {
            while (await refreshTimer.WaitForNextTickAsync(cancellationToken))
            {
                await LoadAsync(showLoading: false, cancellationToken);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException)
        {
        }
    }

    private async Task LoadAsync(bool showLoading, CancellationToken cancellationToken = default)
    {
        if (isRefreshing)
        {
            return;
        }

        isRefreshing = true;
        if (showLoading)
        {
            error = null;
            isLoading = true;
        }

        try
        {
            tasks = await Api.GetTasksAsync(limit: 200, cancellationToken);
            error = null;
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            if (showLoading)
            {
                isLoading = false;
            }

            isRefreshing = false;
        }
    }

    private static RenderFragment GetStatusBadge(BackupTaskStatus status) => builder =>
    {
        var (label, variant) = status switch
        {
            BackupTaskStatus.Success => ("Completed", BadgeVariant.Default),
            BackupTaskStatus.Running => ("Running", BadgeVariant.Secondary),
            BackupTaskStatus.Failed => ("Failed", BadgeVariant.Destructive),
            _ => ("Pending", BadgeVariant.Outline)
        };

        builder.OpenComponent<Badge>(0);
        builder.AddAttribute(1, "Variant", variant);
        builder.AddAttribute(2, "ChildContent", (RenderFragment)(b2 => b2.AddContent(0, label)));
        builder.CloseComponent();
    };

    private static RenderFragment GetTriggerBadge(BackupTaskTrigger trigger) => builder =>
    {
        var (label, variant) = trigger switch
        {
            BackupTaskTrigger.Scheduled => ("Scheduled", BadgeVariant.Secondary),
            _ => ("Manual", BadgeVariant.Outline)
        };

        builder.OpenComponent<Badge>(0);
        builder.AddAttribute(1, "Variant", variant);
        builder.AddAttribute(2, "ChildContent", (RenderFragment)(b2 => b2.AddContent(0, label)));
        builder.CloseComponent();
    };

    public ValueTask DisposeAsync()
    {
        refreshCts?.Cancel();
        refreshTimer?.Dispose();
        refreshCts?.Dispose();
        return ValueTask.CompletedTask;
    }
}
