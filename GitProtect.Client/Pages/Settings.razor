@page "/settings"
@rendermode InteractiveWebAssembly
@inject ApiClient Api

<PageTitle>Settings</PageTitle>

<MudStack Spacing="3">
    <MudPaper Elevation="1" Class="pa-4">
        <MudText Typo="Typo.h4">Settings</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Manage provider, storage, schedule, and retention policy.</MudText>
    </MudPaper>

    <MudTabs Rounded="true" Elevation="1" PanelClass="pa-4">
        <MudTabPanel Text="Provider">
            <MudStack Spacing="2">
                @if (!string.IsNullOrWhiteSpace(providerError))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">@providerError</MudAlert>
                }

                <MudSelect T="ProviderType" Label="Provider" Value="selectedProvider" ValueChanged="OnProviderSelectionChanged" Disabled="@isProviderBusy">
                    <MudSelectItem Value="@ProviderType.GitHub">GitHub</MudSelectItem>
                    <MudSelectItem Value="@ProviderType.GitLab">GitLab</MudSelectItem>
                    <MudSelectItem Value="@ProviderType.Forgejo">Forgejo</MudSelectItem>
                </MudSelect>

                <MudTextField T="string" Label="Instance URL" @bind-Value="providerBaseUrl" Disabled="@isProviderBusy" />
                <MudTextField T="string" Label="Username" @bind-Value="providerUsername" Disabled="@isProviderBusy" />
                <MudTextField T="string" Label="API Key" InputType="MudBlazor.InputType.Password" @bind-Value="providerApiKey" Disabled="@isProviderBusy" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveProvider"
                           Disabled="@isProviderBusy">
                    Save Provider
                </MudButton>
            </MudStack>
        </MudTabPanel>

        <MudTabPanel Text="Storage">
            <MudStack Spacing="2">
                @if (!string.IsNullOrWhiteSpace(storageError))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">@storageError</MudAlert>
                }

                <MudTextField T="string" Label="Endpoint" @bind-Value="storageEndpoint" Disabled="@isStorageBusy" />
                <MudTextField T="string" Label="Region" @bind-Value="storageRegion" Disabled="@isStorageBusy" />
                <MudTextField T="string" Label="Bucket" @bind-Value="storageBucket" Disabled="@isStorageBusy" />
                <MudTextField T="string" Label="Access Key" @bind-Value="storageAccessKey" Disabled="@isStorageBusy" />
                <MudTextField T="string" Label="Secret Key" InputType="MudBlazor.InputType.Password" @bind-Value="storageSecretKey" Disabled="@isStorageBusy" />
                <MudCheckBox T="bool" Label="Use path style" @bind-Value="storageUsePathStyle" Disabled="@isStorageBusy" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveStorage"
                           Disabled="@isStorageBusy">
                    Save Storage
                </MudButton>
            </MudStack>
        </MudTabPanel>

        <MudTabPanel Text="Schedule">
            <MudStack Spacing="2">
                @if (!string.IsNullOrWhiteSpace(scheduleError))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">@scheduleError</MudAlert>
                }

                <MudSwitch T="bool" Label="Enable scheduled backups" @bind-Value="scheduleEnabled" Disabled="@isScheduleBusy" />
                <MudTextField T="string" Label="Cron Expression" @bind-Value="scheduleCron" Disabled="@isScheduleBusy" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveSchedule"
                           Disabled="@isScheduleBusy">
                    Save Schedule
                </MudButton>
            </MudStack>
        </MudTabPanel>

        <MudTabPanel Text="Retention">
            <MudStack Spacing="2">
                @if (!string.IsNullOrWhiteSpace(retentionError))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">@retentionError</MudAlert>
                }

                <MudSwitch T="bool" Label="Enable retention" @bind-Value="retentionEnabled" Disabled="@isRetentionBusy" />
                <MudTextField T="string" Label="Retention Days" @bind-Value="retentionDaysText" Disabled="@(!retentionEnabled || isRetentionBusy)" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveRetention"
                           Disabled="@isRetentionBusy">
                    Save Retention
                </MudButton>
            </MudStack>
        </MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    private List<ProviderStatusDto> providers = new();
    private ProviderType selectedProvider = ProviderType.GitHub;
    private bool isProviderBusy;
    private bool isStorageBusy;
    private bool isScheduleBusy;
    private bool isRetentionBusy;
    private string? providerError;
    private string? storageError;
    private string? scheduleError;
    private string? retentionError;

    private string providerBaseUrl = string.Empty;
    private string providerUsername = string.Empty;
    private string providerApiKey = string.Empty;

    private string storageEndpoint = string.Empty;
    private string storageRegion = string.Empty;
    private string storageBucket = string.Empty;
    private string storageAccessKey = string.Empty;
    private string storageSecretKey = string.Empty;
    private bool storageUsePathStyle;

    private bool scheduleEnabled;
    private string scheduleCron = DefaultCronExpression;

    private const string DefaultCronExpression = "0 0 * * *";
    private const int DefaultRetentionDays = 30;

    private bool retentionEnabled;
    private int retentionDays = DefaultRetentionDays;
    private string retentionDaysText = DefaultRetentionDays.ToString();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        providerError = null;
        storageError = null;
        scheduleError = null;
        retentionError = null;

        try
        {
            providers = await Api.GetProvidersAsync();
        }
        catch (Exception ex)
        {
            providers = new();
            providerError = GetLoadError(ex, "Unable to load provider settings.");
        }

        ApplyProviderSelection();

        try
        {
            var storage = await Api.GetStorageAsync();
            if (storage?.Config is not null)
            {
                storageEndpoint = storage.Config.Endpoint;
                storageRegion = storage.Config.Region;
                storageBucket = storage.Config.Bucket;
                storageAccessKey = storage.Config.AccessKeyId;
                storageSecretKey = storage.Config.SecretAccessKey;
                storageUsePathStyle = storage.Config.UsePathStyle;
            }
        }
        catch (Exception ex)
        {
            storageError = GetLoadError(ex, "Unable to load storage settings.");
        }

        try
        {
            var schedule = await Api.GetBackupScheduleAsync();
            if (schedule is not null)
            {
                scheduleEnabled = schedule.IsEnabled;
                scheduleCron = schedule.CronExpression;
            }
        }
        catch (Exception ex)
        {
            scheduleError = GetLoadError(ex, "Unable to load backup schedule settings.");
        }

        try
        {
            var retention = await Api.GetRetentionPolicyAsync();
            if (retention is not null)
            {
                retentionEnabled = retention.IsEnabled;
                retentionDays = retention.RetentionDays;
                retentionDaysText = retention.RetentionDays.ToString();
            }
        }
        catch (Exception ex)
        {
            retentionError = GetLoadError(ex, "Unable to load retention policy settings.");
        }
    }

    private static string GetLoadError(Exception ex, string fallbackMessage)
    {
        if (ex is HttpRequestException { Message: { Length: > 0 } message })
        {
            return message;
        }

        return fallbackMessage;
    }

    private void ApplyProviderSelection()
    {
        var provider = providers.FirstOrDefault(p => p.Provider == selectedProvider);
        if (provider is null)
        {
            providerBaseUrl = selectedProvider switch
            {
                ProviderType.GitHub => "https://github.com",
                ProviderType.GitLab => "https://gitlab.com",
                ProviderType.Forgejo => "https://codeberg.org",
                _ => string.Empty
            };
            providerUsername = string.Empty;
            providerApiKey = string.Empty;
            return;
        }

        providerBaseUrl = provider.BaseUrl;
        providerUsername = provider.Username;
        providerApiKey = string.Empty;
    }

    private Task OnProviderSelectionChanged(ProviderType provider)
    {
        selectedProvider = provider;
        ApplyProviderSelection();
        return Task.CompletedTask;
    }

    private async Task SaveProvider()
    {
        providerError = null;
        isProviderBusy = true;
        try
        {
            var result = await Api.SaveProviderAsync(selectedProvider, new ProviderUpsertRequest(providerBaseUrl, providerUsername, providerApiKey));
            if (!result.Success || result.Data is null)
            {
                providerError = result.Error ?? "Unable to verify provider. Check credentials.";
                return;
            }

            providers = await Api.GetProvidersAsync();
            ApplyProviderSelection();
        }
        finally
        {
            isProviderBusy = false;
        }
    }

    private async Task SaveStorage()
    {
        storageError = null;
        isStorageBusy = true;
        try
        {
            var result = await Api.SaveStorageAsync(new S3UpsertRequest(storageEndpoint, storageRegion, storageBucket, storageAccessKey, storageSecretKey, storageUsePathStyle));
            if (!result.Success || result.Data is null)
            {
                storageError = result.Error ?? "Unable to verify S3 settings.";
            }
        }
        finally
        {
            isStorageBusy = false;
        }
    }

    private async Task SaveSchedule()
    {
        scheduleError = null;
        isScheduleBusy = true;
        try
        {
            var result = await Api.SaveBackupScheduleAsync(new BackupScheduleUpsertRequest(scheduleEnabled, scheduleCron));
            if (!result.Success || result.Data is null)
            {
                scheduleError = result.Error ?? "Unable to save schedule.";
                return;
            }

            scheduleEnabled = result.Data.IsEnabled;
            scheduleCron = result.Data.CronExpression;
        }
        finally
        {
            isScheduleBusy = false;
        }
    }

    private async Task SaveRetention()
    {
        retentionError = null;

        if (!int.TryParse(retentionDaysText, out var parsedRetentionDays) || parsedRetentionDays < 1)
        {
            retentionError = "Retention days must be a positive whole number.";
            return;
        }

        retentionDays = parsedRetentionDays;
        isRetentionBusy = true;
        try
        {
            var result = await Api.SaveRetentionPolicyAsync(new RetentionPolicyUpsertRequest(retentionEnabled, retentionDays));
            if (!result.Success || result.Data is null)
            {
                retentionError = result.Error ?? "Unable to save retention policy.";
                return;
            }

            retentionEnabled = result.Data.IsEnabled;
            retentionDays = result.Data.RetentionDays;
            retentionDaysText = result.Data.RetentionDays.ToString();
        }
        finally
        {
            isRetentionBusy = false;
        }
    }
}
