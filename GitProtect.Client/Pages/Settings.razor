@page "/settings"
@rendermode InteractiveWebAssembly
@inject ApiClient Api

<PageTitle>Settings</PageTitle>

<div class="space-y-6 max-w-4xl">
    <Card>
        <CardHeader>
            <CardTitle>Settings</CardTitle>
            <CardDescription>Manage provider, storage, schedule, and retention policy.</CardDescription>
        </CardHeader>
    </Card>

    <Tabs DefaultValue="provider" Class="w-full">
        <TabsList>
            <TabsTrigger Value="provider">Provider</TabsTrigger>
            <TabsTrigger Value="storage">Storage</TabsTrigger>
            <TabsTrigger Value="schedule">Schedule</TabsTrigger>
            <TabsTrigger Value="retention">Retention</TabsTrigger>
        </TabsList>

        <TabsContent Value="provider">
            <Card>
                <CardHeader><CardTitle>Provider Settings</CardTitle></CardHeader>
                <CardContent>
                    <div class="space-y-4">
                        @if (!string.IsNullOrWhiteSpace(providerError))
                        {
                            <Badge Variant="BadgeVariant.Destructive">@providerError</Badge>
                        }
                        <div>
                            <label class="text-sm font-medium">Provider</label>
                            <select class="mt-1 w-full rounded-md border bg-background px-3 py-2" @bind="selectedProvider" @bind:after="OnProviderSelectionChanged">
                                <option value="@ProviderType.GitHub">GitHub</option>
                                <option value="@ProviderType.GitLab">GitLab</option>
                                <option value="@ProviderType.Forgejo">Forgejo</option>
                            </select>
                        </div>
                        <div><label class="text-sm font-medium">Instance URL</label><Input @bind-Value="providerBaseUrl" class="mt-1" /></div>
                        <div><label class="text-sm font-medium">Username</label><Input @bind-Value="providerUsername" class="mt-1" /></div>
                        <div><label class="text-sm font-medium">API Key</label><Input @bind-Value="providerApiKey" Type="InputType.Password" class="mt-1" /></div>
                        <Button @onclick="SaveProvider" Disabled="@isProviderBusy">Save Provider</Button>
                    </div>
                </CardContent>
            </Card>
        </TabsContent>

        <TabsContent Value="storage">
            <Card>
                <CardHeader><CardTitle>S3 Storage</CardTitle></CardHeader>
                <CardContent>
                    <div class="space-y-4">
                        @if (!string.IsNullOrWhiteSpace(storageError))
                        {
                            <Badge Variant="BadgeVariant.Destructive">@storageError</Badge>
                        }
                        <div><label class="text-sm font-medium">Endpoint</label><Input @bind-Value="storageEndpoint" class="mt-1" /></div>
                        <div><label class="text-sm font-medium">Region</label><Input @bind-Value="storageRegion" class="mt-1" /></div>
                        <div><label class="text-sm font-medium">Bucket</label><Input @bind-Value="storageBucket" class="mt-1" /></div>
                        <div><label class="text-sm font-medium">Access Key</label><Input @bind-Value="storageAccessKey" class="mt-1" /></div>
                        <div><label class="text-sm font-medium">Secret Key</label><Input @bind-Value="storageSecretKey" Type="InputType.Password" class="mt-1" /></div>
                        <div class="flex items-center gap-2"><Checkbox @bind-Checked="storageUsePathStyle" /><label class="text-sm font-medium">Use path style</label></div>
                        <Button @onclick="SaveStorage" Disabled="@isStorageBusy">Save Storage</Button>
                    </div>
                </CardContent>
            </Card>
        </TabsContent>

        <TabsContent Value="schedule">
            <Card>
                <CardHeader><CardTitle>Backup Schedule</CardTitle></CardHeader>
                <CardContent>
                    <div class="space-y-4">
                        @if (!string.IsNullOrWhiteSpace(scheduleError))
                        {
                            <Badge Variant="BadgeVariant.Destructive">@scheduleError</Badge>
                        }
                        <div class="flex items-center gap-2"><Switch @bind-Checked="scheduleEnabled" /><label class="text-sm font-medium">Enable scheduled backups</label></div>
                        <div><label class="text-sm font-medium">Cron Expression</label><Input @bind-Value="scheduleCron" class="mt-1" /></div>
                        <Button @onclick="SaveSchedule" Disabled="@isScheduleBusy">Save Schedule</Button>
                    </div>
                </CardContent>
            </Card>
        </TabsContent>

        <TabsContent Value="retention">
            <Card>
                <CardHeader><CardTitle>Retention Policy</CardTitle></CardHeader>
                <CardContent>
                    <div class="space-y-4">
                        @if (!string.IsNullOrWhiteSpace(retentionError))
                        {
                            <Badge Variant="BadgeVariant.Destructive">@retentionError</Badge>
                        }
                        <div class="flex items-center gap-2"><Switch @bind-Checked="retentionEnabled" /><label class="text-sm font-medium">Enable retention</label></div>
                        <div><label class="text-sm font-medium">Retention Days</label><Input @bind-Value="retentionDaysText" Type="InputType.Number" Disabled="@(!retentionEnabled)" class="mt-1" /></div>
                        <Button @onclick="SaveRetention" Disabled="@isRetentionBusy">Save Retention</Button>
                    </div>
                </CardContent>
            </Card>
        </TabsContent>
    </Tabs>
</div>

@code {
    private List<ProviderStatusDto> providers = new();
    private ProviderType selectedProvider = ProviderType.GitHub;
    private bool isProviderBusy;
    private bool isStorageBusy;
    private bool isScheduleBusy;
    private bool isRetentionBusy;
    private string? providerError;
    private string? storageError;
    private string? scheduleError;
    private string? retentionError;

    private string providerBaseUrl = string.Empty;
    private string providerUsername = string.Empty;
    private string providerApiKey = string.Empty;

    private string storageEndpoint = string.Empty;
    private string storageRegion = string.Empty;
    private string storageBucket = string.Empty;
    private string storageAccessKey = string.Empty;
    private string storageSecretKey = string.Empty;
    private bool storageUsePathStyle;

    private bool scheduleEnabled;
    private string scheduleCron = DefaultCronExpression;

    private const string DefaultCronExpression = "0 0 * * *";
    private const int DefaultRetentionDays = 30;

    private bool retentionEnabled;
    private int retentionDays = DefaultRetentionDays;
    private string retentionDaysText = DefaultRetentionDays.ToString();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        providers = await Api.GetProvidersAsync();
        ApplyProviderSelection();

        var storage = await Api.GetStorageAsync();
        if (storage?.Config is not null)
        {
            storageEndpoint = storage.Config.Endpoint;
            storageRegion = storage.Config.Region;
            storageBucket = storage.Config.Bucket;
            storageAccessKey = storage.Config.AccessKeyId;
            storageSecretKey = storage.Config.SecretAccessKey;
            storageUsePathStyle = storage.Config.UsePathStyle;
        }

        var schedule = await Api.GetBackupScheduleAsync();
        if (schedule is not null)
        {
            scheduleEnabled = schedule.IsEnabled;
            scheduleCron = schedule.CronExpression;
        }

        var retention = await Api.GetRetentionPolicyAsync();
        if (retention is not null)
        {
            retentionEnabled = retention.IsEnabled;
            retentionDays = retention.RetentionDays;
            retentionDaysText = retention.RetentionDays.ToString();
        }
    }

    private void ApplyProviderSelection()
    {
        var provider = providers.FirstOrDefault(p => p.Provider == selectedProvider);
        if (provider is null)
        {
            providerBaseUrl = selectedProvider switch
            {
                ProviderType.GitHub => "https://github.com",
                ProviderType.GitLab => "https://gitlab.com",
                ProviderType.Forgejo => "https://codeberg.org",
                _ => string.Empty
            };
            providerUsername = string.Empty;
            providerApiKey = string.Empty;
            return;
        }

        providerBaseUrl = provider.BaseUrl;
        providerUsername = provider.Username;
        providerApiKey = string.Empty;
    }

    private Task OnProviderSelectionChanged()
    {
        ApplyProviderSelection();
        return Task.CompletedTask;
    }

    private async Task SaveProvider()
    {
        providerError = null;
        isProviderBusy = true;
        try
        {
            var result = await Api.SaveProviderAsync(selectedProvider, new ProviderUpsertRequest(providerBaseUrl, providerUsername, providerApiKey));
            if (!result.Success || result.Data is null)
            {
                providerError = result.Error ?? "Unable to verify provider. Check credentials.";
                return;
            }

            providers = await Api.GetProvidersAsync();
            ApplyProviderSelection();
        }
        finally
        {
            isProviderBusy = false;
        }
    }

    private async Task SaveStorage()
    {
        storageError = null;
        isStorageBusy = true;
        try
        {
            var result = await Api.SaveStorageAsync(new S3UpsertRequest(storageEndpoint, storageRegion, storageBucket, storageAccessKey, storageSecretKey, storageUsePathStyle));
            if (!result.Success || result.Data is null)
            {
                storageError = result.Error ?? "Unable to verify S3 settings.";
            }
        }
        finally
        {
            isStorageBusy = false;
        }
    }

    private async Task SaveSchedule()
    {
        scheduleError = null;
        isScheduleBusy = true;
        try
        {
            var result = await Api.SaveBackupScheduleAsync(new BackupScheduleUpsertRequest(scheduleEnabled, scheduleCron));
            if (!result.Success || result.Data is null)
            {
                scheduleError = result.Error ?? "Unable to save schedule.";
                return;
            }

            scheduleEnabled = result.Data.IsEnabled;
            scheduleCron = result.Data.CronExpression;
        }
        finally
        {
            isScheduleBusy = false;
        }
    }

    private async Task SaveRetention()
    {
        retentionError = null;

        if (!int.TryParse(retentionDaysText, out var parsedRetentionDays) || parsedRetentionDays < 1)
        {
            retentionError = "Retention days must be a positive whole number.";
            return;
        }

        retentionDays = parsedRetentionDays;
        isRetentionBusy = true;
        try
        {
            var result = await Api.SaveRetentionPolicyAsync(new RetentionPolicyUpsertRequest(retentionEnabled, retentionDays));
            if (!result.Success || result.Data is null)
            {
                retentionError = result.Error ?? "Unable to save retention policy.";
                return;
            }

            retentionEnabled = result.Data.IsEnabled;
            retentionDays = result.Data.RetentionDays;
            retentionDaysText = result.Data.RetentionDays.ToString();
        }
        finally
        {
            isRetentionBusy = false;
        }
    }
}
