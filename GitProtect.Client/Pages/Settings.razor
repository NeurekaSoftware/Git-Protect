@page "/settings"
@rendermode InteractiveWebAssembly
@inject ApiClient Api

<PageTitle>Settings</PageTitle>

<Tabs DefaultValue="provider">
    <TabsList>
        <TabsTrigger Value="provider">Provider</TabsTrigger>
        <TabsTrigger Value="storage">Storage</TabsTrigger>
        <TabsTrigger Value="schedule">Schedule</TabsTrigger>
        <TabsTrigger Value="retention">Retention</TabsTrigger>
    </TabsList>

    <TabsContent Value="provider">
        <Card>
            <CardHeader><CardTitle>Provider Settings</CardTitle></CardHeader>
            <CardContent>
                @if (!string.IsNullOrWhiteSpace(providerError))
                {
                    <Badge Variant="BadgeVariant.Destructive">@providerError</Badge>
                }
                <p>Provider</p>
                <select @bind="selectedProvider" @bind:after="OnProviderSelectionChanged">
                    <option value="@ProviderType.GitHub">GitHub</option>
                    <option value="@ProviderType.GitLab">GitLab</option>
                    <option value="@ProviderType.Forgejo">Forgejo</option>
                </select>
                <p>Instance URL</p>
                <Input @bind-Value="providerBaseUrl" />
                <p>Username</p>
                <Input @bind-Value="providerUsername" />
                <p>API Key</p>
                <Input @bind-Value="providerApiKey" Type="InputType.Password" />
                <div><Button @onclick="SaveProvider" Disabled="@isProviderBusy">Save Provider</Button></div>
            </CardContent>
        </Card>
    </TabsContent>

    <TabsContent Value="storage">
        <Card>
            <CardHeader><CardTitle>S3 Storage</CardTitle></CardHeader>
            <CardContent>
                @if (!string.IsNullOrWhiteSpace(storageError))
                {
                    <Badge Variant="BadgeVariant.Destructive">@storageError</Badge>
                }
                <p>Endpoint</p><Input @bind-Value="storageEndpoint" />
                <p>Region</p><Input @bind-Value="storageRegion" />
                <p>Bucket</p><Input @bind-Value="storageBucket" />
                <p>Access Key</p><Input @bind-Value="storageAccessKey" />
                <p>Secret Key</p><Input @bind-Value="storageSecretKey" Type="InputType.Password" />
                <p>Path Style</p><Checkbox @bind-Checked="storageUsePathStyle" />
                <div><Button @onclick="SaveStorage" Disabled="@isStorageBusy">Save Storage</Button></div>
            </CardContent>
        </Card>
    </TabsContent>

    <TabsContent Value="schedule">
        <Card>
            <CardHeader><CardTitle>Backup Schedule</CardTitle></CardHeader>
            <CardContent>
                @if (!string.IsNullOrWhiteSpace(scheduleError))
                {
                    <Badge Variant="BadgeVariant.Destructive">@scheduleError</Badge>
                }
                <p>Enabled</p><Switch @bind-Checked="scheduleEnabled" />
                <p>Cron Expression</p><Input @bind-Value="scheduleCron" />
                <div><Button @onclick="SaveSchedule" Disabled="@isScheduleBusy">Save Schedule</Button></div>
            </CardContent>
        </Card>
    </TabsContent>

    <TabsContent Value="retention">
        <Card>
            <CardHeader><CardTitle>Retention Policy</CardTitle></CardHeader>
            <CardContent>
                @if (!string.IsNullOrWhiteSpace(retentionError))
                {
                    <Badge Variant="BadgeVariant.Destructive">@retentionError</Badge>
                }
                <p>Enabled</p><Switch @bind-Checked="retentionEnabled" />
                <p>Retention Days</p><Input @bind-Value="retentionDaysText" Type="InputType.Number" Disabled="@(!retentionEnabled)" />
                <div><Button @onclick="SaveRetention" Disabled="@isRetentionBusy">Save Retention</Button></div>
            </CardContent>
        </Card>
    </TabsContent>
</Tabs>

@code {
    private List<ProviderStatusDto> providers = new();
    private ProviderType selectedProvider = ProviderType.GitHub;
    private bool isProviderBusy;
    private bool isStorageBusy;
    private bool isScheduleBusy;
    private bool isRetentionBusy;
    private string? providerError;
    private string? storageError;
    private string? scheduleError;
    private string? retentionError;

    private string providerBaseUrl = string.Empty;
    private string providerUsername = string.Empty;
    private string providerApiKey = string.Empty;

    private string storageEndpoint = string.Empty;
    private string storageRegion = string.Empty;
    private string storageBucket = string.Empty;
    private string storageAccessKey = string.Empty;
    private string storageSecretKey = string.Empty;
    private bool storageUsePathStyle;

    private bool scheduleEnabled;
    private string scheduleCron = DefaultCronExpression;

    private const string DefaultCronExpression = "0 0 * * *";
    private const int DefaultRetentionDays = 30;

    private bool retentionEnabled;
    private int retentionDays = DefaultRetentionDays;
    private string retentionDaysText = DefaultRetentionDays.ToString();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        providers = await Api.GetProvidersAsync();
        ApplyProviderSelection();

        var storage = await Api.GetStorageAsync();
        if (storage?.Config is not null)
        {
            storageEndpoint = storage.Config.Endpoint;
            storageRegion = storage.Config.Region;
            storageBucket = storage.Config.Bucket;
            storageAccessKey = storage.Config.AccessKeyId;
            storageSecretKey = storage.Config.SecretAccessKey;
            storageUsePathStyle = storage.Config.UsePathStyle;
        }

        var schedule = await Api.GetBackupScheduleAsync();
        if (schedule is not null)
        {
            scheduleEnabled = schedule.IsEnabled;
            scheduleCron = schedule.CronExpression;
        }

        var retention = await Api.GetRetentionPolicyAsync();
        if (retention is not null)
        {
            retentionEnabled = retention.IsEnabled;
            retentionDays = retention.RetentionDays;
            retentionDaysText = retention.RetentionDays.ToString();
        }
    }

    private void ApplyProviderSelection()
    {
        var provider = providers.FirstOrDefault(p => p.Provider == selectedProvider);
        if (provider is null)
        {
            providerBaseUrl = selectedProvider switch
            {
                ProviderType.GitHub => "https://github.com",
                ProviderType.GitLab => "https://gitlab.com",
                ProviderType.Forgejo => "https://codeberg.org",
                _ => string.Empty
            };
            providerUsername = string.Empty;
            providerApiKey = string.Empty;
            return;
        }

        providerBaseUrl = provider.BaseUrl;
        providerUsername = provider.Username;
        providerApiKey = string.Empty;
    }

    private Task OnProviderSelectionChanged()
    {
        ApplyProviderSelection();
        return Task.CompletedTask;
    }

    private async Task SaveProvider()
    {
        providerError = null;
        isProviderBusy = true;
        try
        {
            var result = await Api.SaveProviderAsync(selectedProvider, new ProviderUpsertRequest(providerBaseUrl, providerUsername, providerApiKey));
            if (!result.Success || result.Data is null)
            {
                providerError = result.Error ?? "Unable to verify provider. Check credentials.";
                return;
            }

            providers = await Api.GetProvidersAsync();
            ApplyProviderSelection();
        }
        finally
        {
            isProviderBusy = false;
        }
    }

    private async Task SaveStorage()
    {
        storageError = null;
        isStorageBusy = true;
        try
        {
            var result = await Api.SaveStorageAsync(new S3UpsertRequest(storageEndpoint, storageRegion, storageBucket, storageAccessKey, storageSecretKey, storageUsePathStyle));
            if (!result.Success || result.Data is null)
            {
                storageError = result.Error ?? "Unable to verify S3 settings.";
            }
        }
        finally
        {
            isStorageBusy = false;
        }
    }

    private async Task SaveSchedule()
    {
        scheduleError = null;
        isScheduleBusy = true;
        try
        {
            var result = await Api.SaveBackupScheduleAsync(new BackupScheduleUpsertRequest(scheduleEnabled, scheduleCron));
            if (!result.Success || result.Data is null)
            {
                scheduleError = result.Error ?? "Unable to save schedule.";
                return;
            }

            scheduleEnabled = result.Data.IsEnabled;
            scheduleCron = result.Data.CronExpression;
        }
        finally
        {
            isScheduleBusy = false;
        }
    }

    private async Task SaveRetention()
    {
        retentionError = null;

        if (!int.TryParse(retentionDaysText, out var parsedRetentionDays) || parsedRetentionDays < 1)
        {
            retentionError = "Retention days must be a positive whole number.";
            return;
        }

        retentionDays = parsedRetentionDays;
        isRetentionBusy = true;
        try
        {
            var result = await Api.SaveRetentionPolicyAsync(new RetentionPolicyUpsertRequest(retentionEnabled, retentionDays));
            if (!result.Success || result.Data is null)
            {
                retentionError = result.Error ?? "Unable to save retention policy.";
                return;
            }

            retentionEnabled = result.Data.IsEnabled;
            retentionDays = result.Data.RetentionDays;
            retentionDaysText = result.Data.RetentionDays.ToString();
        }
        finally
        {
            isRetentionBusy = false;
        }
    }
}
