@page "/setup"
@rendermode InteractiveWebAssembly
@inject NavigationManager Nav
@inject ApiClient Api

<PageTitle>Setup</PageTitle>

<MudStack Spacing="3">
    <MudPaper Elevation="1" Class="pa-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap" Spacing="2">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h4">Setup Wizard</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Connect a Git provider first, then verify your S3 destination.</MudText>
            </MudStack>
            <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled">Step @step of 2</MudChip>
        </MudStack>
    </MudPaper>

    <MudProgressLinear Color="Color.Primary" Value="@(step * 50)" />

    @if (!string.IsNullOrWhiteSpace(error))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">@error</MudAlert>
    }

    @if (step == 1)
    {
        <MudPaper Elevation="1" Class="pa-4">
            <MudStack Spacing="2">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h6">Provider Connection</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Use an API key or token with repository read access.</MudText>
                </MudStack>

                <MudSelect T="ProviderType" Label="Provider" Value="selectedProvider" ValueChanged="OnProviderChanged" Disabled="@isBusy">
                    <MudSelectItem Value="@ProviderType.GitHub">GitHub</MudSelectItem>
                    <MudSelectItem Value="@ProviderType.GitLab">GitLab</MudSelectItem>
                    <MudSelectItem Value="@ProviderType.Forgejo">Forgejo</MudSelectItem>
                </MudSelect>

                <MudTextField T="string" Label="Instance URL" @bind-Value="baseUrl" Disabled="@isBusy" />
                <MudTextField T="string" Label="Username" @bind-Value="username" Disabled="@isBusy" />
                <MudTextField T="string" Label="API Key" InputType="MudBlazor.InputType.Password" @bind-Value="apiKey" Disabled="@isBusy" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.NavigateNext"
                           OnClick="ContinueToStorage"
                           Disabled="@isBusy">
                    Continue to Storage
                </MudButton>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudPaper Elevation="1" Class="pa-4">
            <MudStack Spacing="2">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h6">Storage Connection</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Configure your S3-compatible storage endpoint.</MudText>
                </MudStack>

                <MudTextField T="string" Label="Endpoint" @bind-Value="s3Endpoint" Disabled="@isBusy" />
                <MudTextField T="string" Label="Region" @bind-Value="s3Region" Disabled="@isBusy" />
                <MudTextField T="string" Label="Bucket" @bind-Value="s3Bucket" Disabled="@isBusy" />
                <MudTextField T="string" Label="Access Key" @bind-Value="s3AccessKey" Disabled="@isBusy" />
                <MudTextField T="string" Label="Secret Key" InputType="MudBlazor.InputType.Password" @bind-Value="s3SecretKey" Disabled="@isBusy" />
                <MudCheckBox T="bool" Label="Use path style" @bind-Value="s3UsePathStyle" Disabled="@isBusy" />

                <MudStack Row="true" Spacing="1">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.ArrowBack"
                               OnClick="BackToProvider"
                               Disabled="@isBusy">
                        Back
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Check"
                               OnClick="SaveStorage"
                               Disabled="@isBusy">
                        Verify and Finish
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    }
</MudStack>

@code {
    private int step = 1;
    private bool isBusy;
    private string? error;

    private ProviderType selectedProvider = ProviderType.GitHub;
    private string baseUrl = "https://github.com";
    private string username = string.Empty;
    private string apiKey = string.Empty;

    private string s3Endpoint = string.Empty;
    private string s3Region = string.Empty;
    private string s3Bucket = string.Empty;
    private string s3AccessKey = string.Empty;
    private string s3SecretKey = string.Empty;
    private bool s3UsePathStyle;

    private async Task ContinueToStorage()
    {
        error = null;
        isBusy = true;
        try
        {
            var result = await Api.SaveProviderAsync(selectedProvider, new ProviderUpsertRequest(baseUrl, username, apiKey));
            if (!result.Success || result.Data is null)
            {
                error = result.Error ?? "Provider validation failed. Please verify your URL and API key.";
                return;
            }

            step = 2;
        }
        finally
        {
            isBusy = false;
        }
    }

    private void BackToProvider()
    {
        step = 1;
    }

    private async Task SaveStorage()
    {
        error = null;
        isBusy = true;
        try
        {
            var result = await Api.SaveStorageAsync(new S3UpsertRequest(s3Endpoint, s3Region, s3Bucket, s3AccessKey, s3SecretKey, s3UsePathStyle));
            if (!result.Success || result.Data is null)
            {
                error = result.Error ?? "Storage validation failed. Please check your S3 credentials.";
                return;
            }

            Nav.NavigateTo($"/backups/{selectedProvider.ToString().ToLowerInvariant()}");
        }
        finally
        {
            isBusy = false;
        }
    }

    private Task OnProviderChanged(ProviderType provider)
    {
        selectedProvider = provider;
        baseUrl = selectedProvider switch
        {
            ProviderType.GitHub => "https://github.com",
            ProviderType.GitLab => "https://gitlab.com",
            ProviderType.Forgejo => "https://codeberg.org",
            _ => baseUrl
        };

        return Task.CompletedTask;
    }
}
