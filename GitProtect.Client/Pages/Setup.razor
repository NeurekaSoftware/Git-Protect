@page "/setup"
@rendermode InteractiveWebAssembly
@inject NavigationManager Nav
@inject ApiClient Api

<PageTitle>Setup</PageTitle>

<div class="space-y-6 max-w-3xl">
    <Card>
        <CardHeader>
            <div>
                <CardTitle>Setup Wizard</CardTitle>
                <CardDescription>Connect a Git provider first, then verify your S3 destination.</CardDescription>
            </div>
            <Badge Variant="@(step == 1 ? BadgeVariant.Secondary : BadgeVariant.Outline)">Step @step of 2</Badge>
        </CardHeader>
    </Card>

    @if (!string.IsNullOrWhiteSpace(error))
    {
        <Badge Variant="BadgeVariant.Destructive">@error</Badge>
    }

    @if (step == 1)
    {
        <Card>
            <CardHeader>
                <CardTitle>Provider Connection</CardTitle>
                <CardDescription>Use an API key or token with repository read access.</CardDescription>
            </CardHeader>
            <CardContent>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium">Provider</label>
                        <select class="mt-1 w-full rounded-md border bg-background px-3 py-2" @bind="selectedProvider" @bind:after="OnProviderChanged">
                            <option value="@ProviderType.GitHub">GitHub</option>
                            <option value="@ProviderType.GitLab">GitLab</option>
                            <option value="@ProviderType.Forgejo">Forgejo</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium">Instance URL</label>
                        <Input @bind-Value="baseUrl" class="mt-1" />
                    </div>
                    <div>
                        <label class="text-sm font-medium">Username</label>
                        <Input @bind-Value="username" class="mt-1" />
                    </div>
                    <div>
                        <label class="text-sm font-medium">API Key</label>
                        <Input @bind-Value="apiKey" Type="InputType.Password" class="mt-1" />
                    </div>
                    <Button @onclick="ContinueToStorage" Disabled="@isBusy">Continue to Storage</Button>
                </div>
            </CardContent>
        </Card>
    }
    else
    {
        <Card>
            <CardHeader>
                <CardTitle>Storage Connection</CardTitle>
                <CardDescription>Configure your S3-compatible storage endpoint.</CardDescription>
            </CardHeader>
            <CardContent>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium">Endpoint</label>
                        <Input @bind-Value="s3Endpoint" class="mt-1" />
                    </div>
                    <div>
                        <label class="text-sm font-medium">Region</label>
                        <Input @bind-Value="s3Region" class="mt-1" />
                    </div>
                    <div>
                        <label class="text-sm font-medium">Bucket</label>
                        <Input @bind-Value="s3Bucket" class="mt-1" />
                    </div>
                    <div>
                        <label class="text-sm font-medium">Access Key</label>
                        <Input @bind-Value="s3AccessKey" class="mt-1" />
                    </div>
                    <div>
                        <label class="text-sm font-medium">Secret Key</label>
                        <Input @bind-Value="s3SecretKey" Type="InputType.Password" class="mt-1" />
                    </div>
                    <div class="flex items-center gap-2">
                        <Checkbox @bind-Checked="s3UsePathStyle" />
                        <label class="text-sm font-medium">Use path style</label>
                    </div>
                    <div class="flex gap-2">
                        <Button Variant="ButtonVariant.Secondary" @onclick="() => step = 1" Disabled="@isBusy">Back</Button>
                        <Button @onclick="SaveStorage" Disabled="@isBusy">Verify &amp; Finish</Button>
                    </div>
                </div>
            </CardContent>
        </Card>
    }
</div>

@code {
    private int step = 1;
    private bool isBusy;
    private string? error;

    private ProviderType selectedProvider = ProviderType.GitHub;
    private string baseUrl = "https://github.com";
    private string username = string.Empty;
    private string apiKey = string.Empty;

    private string s3Endpoint = string.Empty;
    private string s3Region = string.Empty;
    private string s3Bucket = string.Empty;
    private string s3AccessKey = string.Empty;
    private string s3SecretKey = string.Empty;
    private bool s3UsePathStyle;

    private async Task ContinueToStorage()
    {
        error = null;
        isBusy = true;
        try
        {
            var result = await Api.SaveProviderAsync(selectedProvider, new ProviderUpsertRequest(baseUrl, username, apiKey));
            if (!result.Success || result.Data is null)
            {
                error = result.Error ?? "Provider validation failed. Please verify your URL and API key.";
                return;
            }

            step = 2;
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task SaveStorage()
    {
        error = null;
        isBusy = true;
        try
        {
            var result = await Api.SaveStorageAsync(new S3UpsertRequest(s3Endpoint, s3Region, s3Bucket, s3AccessKey, s3SecretKey, s3UsePathStyle));
            if (!result.Success || result.Data is null)
            {
                error = result.Error ?? "Storage validation failed. Please check your S3 credentials.";
                return;
            }

            Nav.NavigateTo($"/backups/{selectedProvider.ToString().ToLowerInvariant()}");
        }
        finally
        {
            isBusy = false;
        }
    }

    private Task OnProviderChanged()
    {
        baseUrl = selectedProvider switch
        {
            ProviderType.GitHub => "https://github.com",
            ProviderType.GitLab => "https://gitlab.com",
            ProviderType.Forgejo => "https://codeberg.org",
            _ => baseUrl
        };

        return Task.CompletedTask;
    }
}
