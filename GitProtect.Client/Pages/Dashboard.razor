@page "/"
@rendermode InteractiveWebAssembly

<PageTitle>Dashboard</PageTitle>

<MudStack Spacing="3">
    <MudPaper Elevation="1" Class="pa-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap" Spacing="2">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h4">Dashboard</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Live posture for provider health, backup success, and activity.</MudText>
            </MudStack>

            <MudStack Row="true" Spacing="1">
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="LoadAsync"
                           Disabled="@isLoading">
                    Refresh
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.PlayArrow"
                           OnClick="RunAllBackups"
                           Disabled="@isLoading">
                    Run All Backups
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (isLoading)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">Loading dashboard...</MudAlert>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">@error</MudAlert>
    }
    else if (dashboard is null)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">No dashboard data available yet.</MudAlert>
    }
    else
    {
        <MudGrid Spacing="2">
            <MudItem xs="12" md="4">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Repositories</MudText>
                    <MudText Typo="Typo.h3">@dashboard.TotalRepositories</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Protected</MudText>
                    <MudText Typo="Typo.h3">@dashboard.ProtectedCount</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Needs Attention</MudText>
                    <MudText Typo="Typo.h3">@dashboard.FailedCount</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudPaper Elevation="1" Class="pa-4">
            <MudStack Spacing="2">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h6">Backup Activity</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Recent run totals grouped by time bucket.</MudText>
                </MudStack>

                @if (dashboard.Activity.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">No recent backup activity.</MudAlert>
                }
                else
                {
                    <MudTable Items="dashboard.Activity" Dense="true" Hover="true" Bordered="true">
                        <HeaderContent>
                            <MudTh>Time</MudTh>
                            <MudTh>Count</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Time">@context.Label</MudTd>
                            <MudTd DataLabel="Count">@context.Value</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudStack>
        </MudPaper>
    }
</MudStack>

@code {
    [Inject] private ApiClient Api { get; set; } = default!;

    private DashboardDto? dashboard;
    private bool isLoading;
    private string? error;

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            error = null;
            dashboard = await Api.GetDashboardAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RunAllBackups()
    {
        isLoading = true;
        try
        {
            var providers = await Api.GetProvidersAsync();
            foreach (var provider in providers.Where(p => p.IsVerified))
            {
                await Api.RunBackupAsync(provider.Provider);
            }

            await LoadAsync();
        }
        finally
        {
            isLoading = false;
        }
    }
}
