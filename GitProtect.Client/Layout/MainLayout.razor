@inherits LayoutComponentBase
@inject NavigationManager Nav

<MudThemeProvider Theme="@AppTheme" IsDarkMode="true" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="1" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleDrawer" />
        <MudText Typo="Typo.h6">GitProtect</MudText>
        <MudSpacer />
        <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined" Size="Size.Small">Monitoring</MudChip>
    </MudAppBar>

    <MudDrawer @bind-Open="drawerOpen"
               Elevation="1"
               Variant="DrawerVariant.Responsive"
               Breakpoint="Breakpoint.Md"
               ClipMode="DrawerClipMode.Always">
        <MudDrawerHeader>
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                <MudAvatar Variant="Variant.Filled" Color="Color.Primary" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Security" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.subtitle1">GitProtect</MudText>
                    <MudText Typo="Typo.caption">Backup Dashboard</MudText>
                </MudStack>
            </MudStack>
        </MudDrawerHeader>

        <MudNavMenu Dense="true">
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>

            <MudNavGroup Title="Backups" Icon="@Icons.Material.Filled.BackupTable" Expanded="@IsBackupsSection">
                <MudNavLink Href="/backups" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ViewList">Overview</MudNavLink>
                <MudNavLink Href="/backups/github" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Code">GitHub</MudNavLink>
                <MudNavLink Href="/backups/gitlab" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountTree">GitLab</MudNavLink>
                <MudNavLink Href="/backups/forgejo" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Storage">Forgejo</MudNavLink>
            </MudNavGroup>

            <MudNavLink Href="/storage" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Cloud">Storage</MudNavLink>
            <MudNavLink Href="/tasks" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Task">Tasks</MudNavLink>
            <MudNavLink Href="/settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Settings">Settings</MudNavLink>
            <MudNavLink Href="/setup" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Build">Setup</MudNavLink>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool drawerOpen = true;

    private bool IsBackupsSection
    {
        get
        {
            var relativePath = Nav.ToBaseRelativePath(Nav.Uri);
            var pathOnly = relativePath.Split('?', '#')[0];
            return string.IsNullOrWhiteSpace(pathOnly)
                ? false
                : pathOnly.StartsWith("backups", StringComparison.OrdinalIgnoreCase);
        }
    }

    private static MudTheme AppTheme => new()
    {
        PaletteDark = new PaletteDark
        {
            Primary = Colors.Blue.Lighten1,
            Secondary = Colors.Teal.Accent3,
            Tertiary = Colors.Cyan.Lighten1
        }
    };

    private void ToggleDrawer()
    {
        drawerOpen = !drawerOpen;
    }
}
